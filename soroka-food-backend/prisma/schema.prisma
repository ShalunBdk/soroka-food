// Prisma schema for Soroka Food database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin users (super admins, admins, and moderators)
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String   // hashed with bcrypt
  role      Role     @default(MODERATOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adminLogs AdminLog[]

  @@map("users")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

// Admin action logs (only accessible to SUPER_ADMIN)
model AdminLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String   // LOGIN, CREATE, UPDATE, DELETE, APPROVE, REJECT, etc.
  resource   String   // recipes, users, categories, comments, settings, etc.
  resourceId Int?     // ID of modified resource (if applicable)
  details    Json?    // Additional details about the action
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("admin_logs")
}

// Recipe categories
model Category {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  slug        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  recipes     RecipeCategory[]

  @@map("categories")
}

// Recipes
model Recipe {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  image       String?  // URL to main recipe image
  cookingTime Int      // in minutes
  calories    Int
  servings    Int
  author      String   @default("Soroka")
  date        DateTime @default(now())
  views       Int      @default(0)
  rating      Float    @default(0)
  status      Status   @default(DRAFT)

  // JSON fields for ingredients, instructions, nutrition, tips
  ingredients Json     // Array of {name: string, amount: string}
  instructions Json    // Array of {stepNumber: number, text: string, images?: string[]}
  nutrition   Json     // {calories: number, protein: number, fat: number, carbs: number}
  tips        Json     // Array of strings
  tags        String[] // Array of tag strings

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categories  RecipeCategory[]
  comments    Comment[]

  @@index([status])
  @@index([createdAt])
  @@index([views])
  @@index([rating])
  @@map("recipes")
}

enum Status {
  PUBLISHED
  DRAFT
}

// Many-to-many relationship between recipes and categories
model RecipeCategory {
  recipeId   Int
  categoryId Int

  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([recipeId, categoryId])
  @@index([categoryId])
  @@map("recipe_categories")
}

// Comments on recipes
model Comment {
  id        Int           @id @default(autoincrement())
  recipeId  Int
  author    String
  email     String?
  rating    Int           // 1-5 stars
  text      String
  status    CommentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  recipe    Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([status])
  @@index([createdAt])
  @@map("comments")
}

enum CommentStatus {
  APPROVED
  PENDING
  SPAM
}

// Newsletter subscribers
model NewsletterSubscriber {
  id                 Int                @id @default(autoincrement())
  email              String             @unique
  status             SubscriptionStatus @default(PENDING)
  verified           Boolean            @default(false)
  verificationToken  String?            @unique
  verifiedAt         DateTime?
  unsubscribeToken   String?            @unique
  subscribedDate     DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  emailLogs          EmailLog[]

  @@index([verificationToken])
  @@index([unsubscribeToken])
  @@map("newsletter_subscribers")
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  UNSUBSCRIBED
}

// Site settings (single row)
model SiteSettings {
  id              Int      @id @default(1)
  siteName        String   @default("Soroka Food")
  siteDescription String?
  logo            String?
  favicon         String?

  // Social links
  youtube         String?
  instagram       String?
  telegram        String?
  tiktok          String?

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  updatedAt       DateTime @updatedAt

  @@map("site_settings")
}

// Static pages (About, Contact, Rules, Advertising)
model StaticPage {
  id        Int      @id @default(autoincrement())
  slug      String   @unique // about, contact, rules, advertising
  title     String
  content   String   @db.Text // HTML or plain text content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("static_pages")
}

// Spam filter settings (single row)
model SpamFilterSettings {
  id        Int      @id @default(1)

  // Custom spam keywords (in addition to built-in ones)
  customKeywords String[] @default([])

  // Filter toggles
  enableKeywordFilter      Boolean @default(true)
  enableUrlFilter          Boolean @default(true)
  enableCapsFilter         Boolean @default(true)
  enableRepetitiveFilter   Boolean @default(true)
  enableDuplicateFilter    Boolean @default(true)

  // Filter thresholds
  maxUrls                  Int     @default(2)   // Max URLs allowed before marking as spam
  capsPercentage           Int     @default(80)  // Percentage of caps to trigger filter (80%)

  updatedAt DateTime @updatedAt

  @@map("spam_filter_settings")
}

// SMTP settings for email sending (single row, SUPER_ADMIN only)
model SmtpSettings {
  id                Int      @id @default(1)
  host              String   @default("smtp.gmail.com")
  port              Int      @default(587)
  secure            Boolean  @default(false) // true for 465, false for other ports
  user              String   @default("")
  password          String   @default("") // Encrypted password
  fromEmail         String   @default("noreply@sorokafood.com")
  fromName          String   @default("Soroka Food")
  enabled           Boolean  @default(false)
  updatedAt         DateTime @updatedAt

  @@map("smtp_settings")
}

// Email templates
model EmailTemplate {
  id          Int      @id @default(autoincrement())
  name        String   @unique // verification, welcome, new-recipe, unsubscribe
  subject     String
  bodyHtml    String   @db.Text // HTML version
  bodyText    String   @db.Text // Plain text fallback
  variables   String[] @default([]) // Available variables: recipeName, recipeUrl, etc.
  isDefault   Boolean  @default(false)
  type        EmailTemplateType
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  emailLogs   EmailLog[]

  @@map("email_templates")
}

enum EmailTemplateType {
  VERIFICATION
  WELCOME
  NEW_RECIPE
  UNSUBSCRIBE
}

// Email sending logs
model EmailLog {
  id                     Int                   @id @default(autoincrement())
  subscriberId           Int
  templateId             Int?
  subject                String
  recipient              String
  status                 EmailStatus           @default(PENDING)
  error                  String?               @db.Text
  sentAt                 DateTime?
  createdAt              DateTime              @default(now())

  subscriber             NewsletterSubscriber  @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  template               EmailTemplate?        @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([subscriberId])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}
