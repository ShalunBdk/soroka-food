// Prisma schema for Soroka Food database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin users (super admins, admins, and moderators)
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String   // hashed with bcrypt
  role      Role     @default(MODERATOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

// Recipe categories
model Category {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  slug        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  recipes     RecipeCategory[]

  @@map("categories")
}

// Recipes
model Recipe {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  image       String?  // URL to main recipe image
  cookingTime Int      // in minutes
  calories    Int
  servings    Int
  author      String   @default("Soroka")
  date        DateTime @default(now())
  views       Int      @default(0)
  rating      Float    @default(0)
  status      Status   @default(DRAFT)

  // JSON fields for ingredients, instructions, nutrition, tips
  ingredients Json     // Array of {name: string, amount: string}
  instructions Json    // Array of {stepNumber: number, text: string, images?: string[]}
  nutrition   Json     // {calories: number, protein: number, fat: number, carbs: number}
  tips        Json     // Array of strings
  tags        String[] // Array of tag strings

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categories  RecipeCategory[]
  comments    Comment[]

  @@map("recipes")
}

enum Status {
  PUBLISHED
  DRAFT
}

// Many-to-many relationship between recipes and categories
model RecipeCategory {
  recipeId   Int
  categoryId Int

  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([recipeId, categoryId])
  @@map("recipe_categories")
}

// Comments on recipes
model Comment {
  id        Int           @id @default(autoincrement())
  recipeId  Int
  author    String
  email     String?
  rating    Int           // 1-5 stars
  text      String
  status    CommentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  recipe    Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("comments")
}

enum CommentStatus {
  APPROVED
  PENDING
  SPAM
}

// Newsletter subscribers
model NewsletterSubscriber {
  id             Int                @id @default(autoincrement())
  email          String             @unique
  status         SubscriptionStatus @default(ACTIVE)
  subscribedDate DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@map("newsletter_subscribers")
}

enum SubscriptionStatus {
  ACTIVE
  UNSUBSCRIBED
}

// Site settings (single row)
model SiteSettings {
  id              Int      @id @default(1)
  siteName        String   @default("Soroka Food")
  siteDescription String?
  logo            String?
  favicon         String?

  // Social links
  youtube         String?
  instagram       String?
  telegram        String?
  tiktok          String?

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  updatedAt       DateTime @updatedAt

  @@map("site_settings")
}

// Static pages (About, Contact, Rules, Advertising)
model StaticPage {
  id        Int      @id @default(autoincrement())
  slug      String   @unique // about, contact, rules, advertising
  title     String
  content   String   @db.Text // HTML or plain text content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("static_pages")
}

// Spam filter settings (single row)
model SpamFilterSettings {
  id        Int      @id @default(1)

  // Custom spam keywords (in addition to built-in ones)
  customKeywords String[] @default([])

  // Filter toggles
  enableKeywordFilter      Boolean @default(true)
  enableUrlFilter          Boolean @default(true)
  enableCapsFilter         Boolean @default(true)
  enableRepetitiveFilter   Boolean @default(true)
  enableDuplicateFilter    Boolean @default(true)

  // Filter thresholds
  maxUrls                  Int     @default(2)   // Max URLs allowed before marking as spam
  capsPercentage           Int     @default(80)  // Percentage of caps to trigger filter (80%)

  updatedAt DateTime @updatedAt

  @@map("spam_filter_settings")
}
